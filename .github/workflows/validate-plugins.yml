name: Validate Plugins

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  validate-marketplace:
    name: Validate Marketplace Configuration
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup jq
        uses: dcarbone/install-jq-action@v3

      - name: Validate marketplace.json syntax
        run: |
          echo "Validating marketplace.json..."
          jq empty .claude-plugin/marketplace.json
          echo "✓ Marketplace JSON is valid"

      - name: Check required fields
        run: |
          echo "Checking required marketplace fields..."

          if ! jq -e ".name" .claude-plugin/marketplace.json > /dev/null; then
            echo "✗ Missing required field: name"
            exit 1
          fi
          echo "✓ Field 'name' present"

          if ! jq -e ".owner" .claude-plugin/marketplace.json > /dev/null; then
            echo "✗ Missing required field: owner"
            exit 1
          fi
          echo "✓ Field 'owner' present"

          if ! jq -e ".owner.name" .claude-plugin/marketplace.json > /dev/null; then
            echo "✗ Missing required field: owner.name"
            exit 1
          fi
          echo "✓ Field 'owner.name' present"

          if ! jq -e ".plugins" .claude-plugin/marketplace.json > /dev/null; then
            echo "✗ Missing required field: plugins"
            exit 1
          fi
          echo "✓ Field 'plugins' present"

          if ! jq -e ".plugins | type == \"array\"" .claude-plugin/marketplace.json > /dev/null; then
            echo "✗ Field 'plugins' must be an array"
            exit 1
          fi
          echo "✓ Field 'plugins' is an array"

      - name: Validate plugin entries
        run: |
          echo "Validating plugin entries..."

          PLUGIN_COUNT=$(jq '.plugins | length' .claude-plugin/marketplace.json)

          for ((i=0; i<$PLUGIN_COUNT; i++)); do
            PLUGIN_NAME=$(jq -r ".plugins[$i].name" .claude-plugin/marketplace.json)
            echo ""
            echo "Checking plugin: $PLUGIN_NAME"

            # Check required fields
            if ! jq -e ".plugins[$i].name" .claude-plugin/marketplace.json > /dev/null; then
              echo "✗ Plugin $((i+1)): Missing 'name'"
              exit 1
            fi
            echo "✓ Field 'name' present"

            if ! jq -e ".plugins[$i].source" .claude-plugin/marketplace.json > /dev/null; then
              echo "✗ Plugin $((i+1)): Missing 'source'"
              exit 1
            fi
            echo "✓ Field 'source' present"

            # Validate source format
            SOURCE_TYPE=$(jq -r ".plugins[$i].source | type" .claude-plugin/marketplace.json)

            if [ "$SOURCE_TYPE" == "object" ]; then
              SOURCE_KIND=$(jq -r ".plugins[$i].source.source" .claude-plugin/marketplace.json)

              if [ "$SOURCE_KIND" == "github" ]; then
                if ! jq -e ".plugins[$i].source.repo" .claude-plugin/marketplace.json > /dev/null; then
                  echo "✗ GitHub source missing 'repo' field"
                  exit 1
                fi
                REPO=$(jq -r ".plugins[$i].source.repo" .claude-plugin/marketplace.json)
                echo "✓ GitHub source: $REPO"
              elif [ "$SOURCE_KIND" == "url" ]; then
                if ! jq -e ".plugins[$i].source.url" .claude-plugin/marketplace.json > /dev/null; then
                  echo "✗ URL source missing 'url' field"
                  exit 1
                fi
                echo "✓ Git URL source configured"
              fi
            else
              echo "✓ Local path source: $(jq -r ".plugins[$i].source" .claude-plugin/marketplace.json)"
            fi

            # Check author format if present
            if jq -e ".plugins[$i].author" .claude-plugin/marketplace.json > /dev/null 2>&1; then
              if ! jq -e ".plugins[$i].author.name" .claude-plugin/marketplace.json > /dev/null; then
                echo "✗ Field 'author.name' required when 'author' present"
                exit 1
              fi
              echo "✓ Author format valid"
            fi
          done

          echo ""
          echo "✅ All plugin entries valid"

      - name: Check for duplicate names
        run: |
          echo "Checking for duplicate plugin names..."

          DUPLICATES=$(jq -r '.plugins[].name' .claude-plugin/marketplace.json | sort | uniq -d)

          if [ -n "$DUPLICATES" ]; then
            echo "✗ Duplicate plugin names found:"
            echo "$DUPLICATES"
            exit 1
          fi

          echo "✓ No duplicate plugin names"

  verify-github-sources:
    name: Verify GitHub Sources Exist
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup jq
        uses: dcarbone/install-jq-action@v3

      - name: Check GitHub repositories exist
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Verifying GitHub repository sources..."

          PLUGIN_COUNT=$(jq '.plugins | length' .claude-plugin/marketplace.json)

          for ((i=0; i<$PLUGIN_COUNT; i++)); do
            SOURCE_TYPE=$(jq -r ".plugins[$i].source.source // \"local\"" .claude-plugin/marketplace.json)

            if [ "$SOURCE_TYPE" != "github" ]; then
              continue
            fi

            PLUGIN_NAME=$(jq -r ".plugins[$i].name" .claude-plugin/marketplace.json)
            REPO=$(jq -r ".plugins[$i].source.repo" .claude-plugin/marketplace.json)

            echo "Checking $PLUGIN_NAME -> $REPO"

            if ! gh api "repos/$REPO" > /dev/null 2>&1; then
              echo "✗ Repository not found or not accessible: $REPO"
              exit 1
            fi

            echo "✓ Repository exists: $REPO"
          done

          echo ""
          echo "✅ All GitHub sources verified"
